{"version":3,"file":"WebSocketManager.js","sourceRoot":"","sources":["WebSocketManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { ConnectionState, WebSocketManagerOptions, WebSocketEventHandlers } from '../../types/common/connection';\nimport { ConnectionError } from '../../types/common/error';\n\n// Global instance counter for debugging\nlet instanceCounter = 0;\n\ninterface WebSocketEvent {\n  type: 'state' | 'message' | 'binary' | 'error';\n  state?: ConnectionState;\n  data?: any;\n  error?: ConnectionError;\n}\n\ntype WebSocketEventListener = (event: WebSocketEvent) => void;\n\nexport class WebSocketManager {\n  protected ws: WebSocket | null = null;\n  protected connectionState: ConnectionState = 'disconnected';\n  protected reconnectAttempts = 0;\n  protected reconnectTimer: number | null = null;\n  protected isManualClose = false;\n  protected instanceId: number;\n  protected eventListeners: Set<WebSocketEventListener> = new Set();\n\n  constructor(\n    protected options: WebSocketManagerOptions,\n    protected handlers: WebSocketEventHandlers = {}\n  ) {\n    this.instanceId = ++instanceCounter;\n    this.log(`ðŸ—ï¸ WebSocketManager #${this.instanceId} created`);\n  }\n\n  protected log(message: string, data?: any): void {\n    if (this.options.debug) {\n      console.log(`[WebSocketManager] ${message}`, data || '');\n    }\n  }\n\n  protected updateConnectionState(newState: ConnectionState): void {\n    if (this.connectionState !== newState) {\n      this.log(`ðŸ”„ Connection state: ${this.connectionState} â†’ ${newState}`);\n      this.connectionState = newState;\n      this.handlers.onConnectionStateChange?.(newState);\n      this.notifyListeners({ type: 'state', state: newState });\n    }\n  }\n\n  protected createConnection(): void {\n    try {\n      this.log('ðŸ”Œ Creating new WebSocket connection...');\n      this.updateConnectionState('connecting');\n      \n      const url = this.buildWebSocketURL();\n      \n      this.log('ðŸ”‘ Using subprotocol authentication with API key');\n      this.log('ðŸ”— Full URL:', url);\n      this.log('ðŸ”‘ API Key:', this.options.apiKey.substring(0, 10) + '...');\n      \n      this.ws = new WebSocket(url, ['token', this.options.apiKey]);\n      this.log('ðŸ“¡ WebSocket readyState after creation:', this.ws.readyState);\n      \n      this.setupEventHandlers();\n      \n    } catch (error) {\n      this.handleConnectionError(error as Error);\n    }\n  }\n\n  protected setupEventHandlers(): void {\n    if (!this.ws) return;\n\n    this.ws.onopen = () => {\n      this.log('âœ… WebSocket opened successfully');\n      this.updateConnectionState('connected');\n      this.reconnectAttempts = 0;\n      this.handlers.onOpen?.();\n    };\n\n    this.ws.onmessage = (event: MessageEvent) => {\n      try {\n        if (event.data instanceof ArrayBuffer || event.data instanceof Blob) {\n          if (event.data instanceof Blob) {\n            event.data.arrayBuffer().then(buffer => {\n              this.handlers.onMessage?.(buffer);\n              this.notifyListeners({ type: 'binary', data: buffer });\n            });\n          } else {\n            this.handlers.onMessage?.(event.data);\n            this.notifyListeners({ type: 'binary', data: event.data });\n          }\n        } else if (typeof event.data === 'string') {\n          const data = JSON.parse(event.data);\n          this.handlers.onMessage?.(data);\n          this.notifyListeners({ type: 'message', data });\n        }\n      } catch (error) {\n        this.handleMessageError(error as Error);\n      }\n    };\n\n    this.ws.onclose = (event: CloseEvent) => {\n      this.log(`ðŸ”´ WebSocket closed - Code: ${event.code}, Reason: ${event.reason || 'No reason'}`);\n      this.updateConnectionState('disconnected');\n      this.ws = null;\n      \n      this.handlers.onClose?.();\n\n      if (!this.isManualClose && this.shouldReconnect()) {\n        this.scheduleReconnect();\n      }\n    };\n\n    this.ws.onerror = () => {\n      this.handleConnectionError(new Error('WebSocket connection error'));\n    };\n  }\n\n  protected handleConnectionError(error: Error): void {\n    this.log('ðŸš¨ Connection error:', error);\n    this.updateConnectionState('error');\n    \n    const connectionError: ConnectionError = {\n      name: 'ConnectionError',\n      message: error.message,\n      type: 'connection',\n      code: 'WEBSOCKET_ERROR',\n      details: { originalError: error }\n    };\n\n    this.handlers.onError?.(connectionError);\n    this.notifyListeners({ type: 'error', error: connectionError });\n    \n    if (this.shouldReconnect()) {\n      this.scheduleReconnect();\n    }\n  }\n\n  protected handleMessageError(error: Error): void {\n    const connectionError = new ConnectionError('Failed to parse WebSocket message', {\n      originalError: error\n    });\n    this.handlers.onError?.(connectionError);\n    this.notifyListeners({ type: 'error', error: connectionError });\n  }\n\n  protected shouldReconnect(): boolean {\n    const maxAttempts = this.options.maxReconnectAttempts ?? 3;\n    return this.reconnectAttempts < maxAttempts;\n  }\n\n  protected scheduleReconnect(): void {\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer);\n    }\n\n    const baseDelay = this.options.reconnectDelay ?? 1000;\n    const delay = baseDelay * Math.pow(2, this.reconnectAttempts);\n    \n    this.reconnectTimer = window.setTimeout(() => {\n      this.reconnectAttempts++;\n      this.createConnection();\n    }, delay);\n  }\n\n  public connect(): void {\n    if (this.connectionState === 'connected' || this.connectionState === 'connecting') {\n      return;\n    }\n\n    this.isManualClose = false;\n    this.createConnection();\n  }\n\n  public disconnect(): void {\n    this.isManualClose = true;\n    \n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer);\n      this.reconnectTimer = null;\n    }\n\n    if (this.ws) {\n      this.ws.close(1000, 'Manual disconnect');\n    }\n  }\n\n  public sendMessage(message: any): void {\n    if (this.connectionState !== 'connected' || !this.ws) {\n      throw new Error('WebSocket is not connected');\n    }\n\n    try {\n      const jsonMessage = JSON.stringify(message);\n      this.ws.send(jsonMessage);\n    } catch (error) {\n      this.handleConnectionError(error as Error);\n    }\n  }\n\n  public sendBinary(data: ArrayBuffer): void {\n    if (this.connectionState !== 'connected' || !this.ws) {\n      throw new Error('WebSocket is not connected');\n    }\n\n    try {\n      this.ws.send(data);\n    } catch (error) {\n      this.handleConnectionError(error as Error);\n    }\n  }\n\n  public getState(): ConnectionState {\n    return this.connectionState;\n  }\n\n  public isConnected(): boolean {\n    return this.connectionState === 'connected';\n  }\n\n  public cleanup(): void {\n    this.disconnect();\n    this.eventListeners.clear();\n  }\n\n  protected buildWebSocketURL(): string {\n    if (!this.options.url) {\n      throw new Error('WebSocket URL is required');\n    }\n    return this.options.url;\n  }\n\n  public addEventListener(listener: WebSocketEventListener): () => void {\n    this.eventListeners.add(listener);\n    return () => this.eventListeners.delete(listener);\n  }\n\n  protected notifyListeners(event: WebSocketEvent): void {\n    Array.from(this.eventListeners).forEach(listener => listener(event));\n  }\n} "]}