{"version":3,"file":"MicrophoneManager.js","sourceRoot":"","sources":["MicrophoneManager.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  MicrophoneConfig,\n  MicrophoneState,\n  MicrophoneEventHandlers,\n  MicrophonePermissionResult,\n  AudioWorkletMessage\n} from '../../types/common/microphone';\nimport { MICROPHONE_CONFIG, AUDIO_CONTEXT_CONFIG } from '../shared/config';\nimport { AudioError } from '../../types/common/error';\n\n/**\n * Manages microphone access, recording, and audio processing.\n * This class is responsible for:\n * 1. Microphone permissions and access\n * 2. Audio context and worklet setup\n * 3. Recording state management\n * 4. Audio data processing and streaming\n */\nexport class MicrophoneManager {\n  private audioContext: AudioContext | null = null;\n  private mediaStream: MediaStream | null = null;\n  private sourceNode: MediaStreamAudioSourceNode | null = null;\n  private workletNode: AudioWorkletNode | null = null;\n  private state: MicrophoneState = {\n    isInitialized: false,\n    isRecording: false,\n    hasPermission: false,\n    permissionState: null,\n    error: null\n  };\n\n  constructor(\n    private readonly config: MicrophoneConfig = MICROPHONE_CONFIG,\n    private readonly handlers: MicrophoneEventHandlers = {}\n  ) {}\n\n  /**\n   * Checks and requests microphone permissions\n   */\n  public async checkPermissions(): Promise<MicrophonePermissionResult> {\n    try {\n      // Try permissions API first\n      if (navigator.permissions) {\n        const permissionStatus = await navigator.permissions.query({ \n          name: 'microphone' as PermissionName \n        });\n        \n        this.state.permissionState = permissionStatus.state;\n        this.state.hasPermission = permissionStatus.state === 'granted';\n\n        // Listen for permission changes\n        permissionStatus.addEventListener('change', () => {\n          this.state.permissionState = permissionStatus.state;\n          this.state.hasPermission = permissionStatus.state === 'granted';\n          this.handlers.onPermissionChange?.(permissionStatus.state);\n        });\n\n        return {\n          granted: this.state.hasPermission,\n          state: permissionStatus.state\n        };\n      }\n\n      // Fallback: try direct access\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: this.config.constraints\n      });\n      stream.getTracks().forEach(track => track.stop()); // Clean up test stream\n\n      this.state.hasPermission = true;\n      this.state.permissionState = 'granted';\n\n      return {\n        granted: true,\n        state: 'granted'\n      };\n    } catch (error) {\n      this.state.hasPermission = false;\n      this.state.permissionState = 'denied';\n      \n      const audioError = new AudioError('Microphone permission denied', {\n        originalError: error instanceof Error ? error : new Error('Unknown error')\n      });\n      \n      this.handlers.onError?.(audioError);\n      throw audioError;\n    }\n  }\n\n  /**\n   * Initializes the audio context and worklet\n   */\n  public async initialize(): Promise<void> {\n    try {\n      if (this.state.isInitialized) {\n        throw new AudioError('Microphone already initialized');\n      }\n\n      // Create audio context\n      this.audioContext = new AudioContext(AUDIO_CONTEXT_CONFIG);\n\n      // Resume if suspended\n      if (this.audioContext.state === 'suspended') {\n        await this.audioContext.resume();\n      }\n\n      // Load worklet\n      await this.loadWorklet();\n\n      this.state.isInitialized = true;\n      this.state.error = null;\n      this.handlers.onInitialized?.();\n    } catch (error) {\n      const audioError = error instanceof AudioError ? error : new AudioError('Failed to initialize microphone', {\n        originalError: error instanceof Error ? error : new Error('Unknown error')\n      });\n      this.handlers.onError?.(audioError);\n      throw audioError;\n    }\n  }\n\n  /**\n   * Starts recording from the microphone\n   */\n  public async startRecording(): Promise<void> {\n    try {\n      if (!this.state.isInitialized || !this.audioContext) {\n        throw new AudioError('Microphone not initialized');\n      }\n\n      if (this.state.isRecording) {\n        return; // Already recording\n      }\n\n      // Get microphone access\n      this.mediaStream = await navigator.mediaDevices.getUserMedia({\n        audio: this.config.constraints\n      });\n\n      // Create and connect nodes\n      this.sourceNode = this.audioContext.createMediaStreamSource(this.mediaStream);\n      this.workletNode = new AudioWorkletNode(this.audioContext, 'microphone-processor', {\n        numberOfInputs: 1,\n        numberOfOutputs: 0,\n        channelCount: this.config.constraints.channelCount\n      });\n\n      // Handle worklet messages\n      this.workletNode.port.onmessage = (event) => {\n        const message = event.data as AudioWorkletMessage;\n        \n        if (message.type === 'audio' && message.data) {\n          this.handlers.onAudioData?.(message.data);\n        }\n      };\n\n      // Connect nodes\n      this.sourceNode.connect(this.workletNode);\n\n      // Start processing\n      this.workletNode.port.postMessage({ type: 'start' });\n\n      this.state.isRecording = true;\n      this.handlers.onRecordingStart?.();\n    } catch (error) {\n      const audioError = error instanceof AudioError ? error : new AudioError('Failed to start recording', {\n        originalError: error instanceof Error ? error : new Error('Unknown error')\n      });\n      this.handlers.onError?.(audioError);\n      throw audioError;\n    }\n  }\n\n  /**\n   * Stops recording\n   */\n  public stopRecording(): void {\n    try {\n      if (!this.state.isRecording) {\n        return; // Not recording\n      }\n\n      // Stop worklet\n      this.workletNode?.port.postMessage({ type: 'stop' });\n\n      // Disconnect nodes\n      this.sourceNode?.disconnect();\n      this.workletNode?.disconnect();\n\n      // Stop media stream\n      this.mediaStream?.getTracks().forEach(track => track.stop());\n\n      // Clear references\n      this.sourceNode = null;\n      this.workletNode = null;\n      this.mediaStream = null;\n\n      this.state.isRecording = false;\n      this.handlers.onRecordingStop?.();\n    } catch (error) {\n      const audioError = error instanceof AudioError ? error : new AudioError('Failed to stop recording', {\n        originalError: error instanceof Error ? error : new Error('Unknown error')\n      });\n      this.handlers.onError?.(audioError);\n      throw audioError;\n    }\n  }\n\n  /**\n   * Cleans up all resources\n   */\n  public cleanup(): void {\n    this.stopRecording();\n    \n    if (this.audioContext) {\n      this.audioContext.close();\n      this.audioContext = null;\n    }\n\n    this.state = {\n      isInitialized: false,\n      isRecording: false,\n      hasPermission: false,\n      permissionState: null,\n      error: null\n    };\n  }\n\n  // State accessors\n  public isRecording(): boolean {\n    return this.state.isRecording;\n  }\n\n  public isInitialized(): boolean {\n    return this.state.isInitialized;\n  }\n\n  public hasPermission(): boolean {\n    return this.state.hasPermission;\n  }\n\n  public getState(): MicrophoneState {\n    return { ...this.state };\n  }\n\n  private async loadWorklet(): Promise<void> {\n    if (!this.audioContext) {\n      throw new AudioError('Audio context not initialized');\n    }\n\n    // Define worklet code\n    const workletCode = `\n      class MicrophoneProcessor extends AudioWorkletProcessor {\n        constructor() {\n          super();\n          \n          this.isRecording = false;\n          this.sampleRate = ${this.audioContext.sampleRate}; // Use actual audio context sample rate\n          this.bufferSize = ${this.config.bufferSize};\n          this.buffer = new Float32Array(this.bufferSize);\n          this.bufferIndex = 0;\n          \n          this.port.onmessage = (event) => {\n            if (event.data.type === 'start') {\n              this.isRecording = true;\n            } else if (event.data.type === 'stop') {\n              this.isRecording = false;\n            }\n          };\n        }\n        \n        process(inputs) {\n          if (!this.isRecording || !inputs[0] || !inputs[0][0]) {\n            return true;\n          }\n          \n          const input = inputs[0][0];\n          \n          for (let i = 0; i < input.length; i++) {\n            this.buffer[this.bufferIndex++] = input[i];\n            \n            if (this.bufferIndex >= this.bufferSize) {\n              this.sendBuffer();\n              this.bufferIndex = 0;\n            }\n          }\n          \n          return true;\n        }\n        \n        sendBuffer() {\n          const audioData = this.buffer.slice(0, this.bufferIndex);\n          const pcmData = new Int16Array(audioData.length);\n          \n          for (let i = 0; i < audioData.length; i++) {\n            const s = Math.max(-1, Math.min(1, audioData[i]));\n            pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;\n          }\n          \n          this.port.postMessage({\n            type: 'audio',\n            data: pcmData.buffer\n          }, [pcmData.buffer]);\n        }\n      }\n      \n      registerProcessor('microphone-processor', MicrophoneProcessor);\n    `;\n\n    // Create blob URL\n    const blob = new Blob([workletCode], { type: 'application/javascript' });\n    const workletUrl = URL.createObjectURL(blob);\n\n    try {\n      await this.audioContext.audioWorklet.addModule(workletUrl);\n    } finally {\n      URL.revokeObjectURL(workletUrl);\n    }\n  }\n} "]}