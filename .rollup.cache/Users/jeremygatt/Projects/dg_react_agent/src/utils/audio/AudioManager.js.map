{"version":3,"file":"AudioManager.js","sourceRoot":"","sources":["AudioManager.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { AudioError } from '../../types/common/error';\nimport {\n  createOptimizedAudioContext,\n  createAudioBuffer,\n  playAudioBuffer,\n  validateWebAudioSupport\n} from './AudioUtils';\nimport { MicrophoneManager } from './MicrophoneManager';\nimport { MicrophoneConfig, MicrophoneEventHandlers } from '../../types/common/microphone';\n\ninterface AudioManagerOptions {\n  debug?: boolean;\n  enableVolumeControl?: boolean;\n  initialVolume?: number;\n  microphoneConfig?: Partial<MicrophoneConfig>;\n}\n\ninterface AudioEventHandlers {\n  onAudioStart?: () => void;\n  onAudioEnd?: () => void;\n  onError?: (error: AudioError) => void;\n  onMicrophoneData?: (data: ArrayBuffer) => void;\n  onMicrophoneStart?: () => void;\n  onMicrophoneStop?: () => void;\n}\n\nexport class AudioManager {\n  private audioContext: AudioContext | null = null;\n  private gainNode: GainNode | null = null;\n  private analyzer: AnalyserNode | null = null;\n  private startTimeRef = { current: 0 };\n  private currentSource: AudioBufferSourceNode | null = null;\n  private isPlaying = false;\n  private isRecording = false;\n  private debug: boolean;\n  private microphoneManager: MicrophoneManager | null = null;\n\n  constructor(\n    private options: AudioManagerOptions = {},\n    private handlers: AudioEventHandlers = {}\n  ) {\n    this.debug = options.debug || false;\n  }\n\n  private log(message: string, data?: any): void {\n    if (this.debug) {\n      console.log(`[AudioManager] ${message}`, data || '');\n    }\n  }\n\n  public async initialize(): Promise<void> {\n    try {\n      // Validate Web Audio support\n      const support = validateWebAudioSupport();\n      if (!support.supported) {\n        throw new Error(`Web Audio API not supported: ${support.missingFeatures.join(', ')}`);\n      }\n\n      // Create audio context\n      this.audioContext = createOptimizedAudioContext();\n\n      // Create gain node if volume control is enabled\n      if (this.options.enableVolumeControl && this.audioContext) {\n        this.gainNode = this.audioContext.createGain();\n        this.gainNode.gain.value = this.options.initialVolume || 1.0;\n        this.gainNode.connect(this.audioContext.destination);\n      }\n\n      // Create analyzer node\n      if (this.audioContext) {\n        this.analyzer = this.audioContext.createAnalyser();\n        this.analyzer.fftSize = 2048;\n      }\n\n      // Note: Microphone initialization is deferred until user interaction\n      // due to browser security requirements\n\n      this.log('Audio manager initialized');\n    } catch (error) {\n      this.handleError(error as Error, 'initialize');\n      throw error;\n    }\n  }\n\n  private async initializeMicrophone(): Promise<void> {\n    try {\n      const microphoneHandlers: MicrophoneEventHandlers = {\n        onAudioData: (data) => this.handlers.onMicrophoneData?.(data),\n        onRecordingStart: () => {\n          this.isRecording = true;\n          this.handlers.onMicrophoneStart?.();\n        },\n        onRecordingStop: () => {\n          this.isRecording = false;\n          this.handlers.onMicrophoneStop?.();\n        },\n        onError: (error) => this.handleError(error, 'microphone')\n      };\n\n      this.microphoneManager = new MicrophoneManager(\n        { ...this.options.microphoneConfig, debug: this.debug },\n        microphoneHandlers\n      );\n\n      await this.microphoneManager.initialize();\n      this.log('Microphone manager initialized');\n    } catch (error) {\n      this.handleError(error as Error, 'initializeMicrophone');\n      throw error;\n    }\n  }\n\n  private handleError(error: Error, context: string): void {\n    const audioError: AudioError = {\n      name: 'AudioError',\n      message: `${context}: ${error.message}`,\n      type: 'audio',\n      code: 'AUDIO_ERROR',\n      details: {\n        context,\n        originalError: error,\n        audioContextState: this.audioContext?.state\n      }\n    };\n\n    if (this.debug) {\n      console.error('Audio Error:', audioError);\n    }\n\n    this.handlers.onError?.(audioError);\n  }\n\n  public async queueAudio(data: ArrayBuffer): Promise<void> {\n    if (!this.audioContext) {\n      throw new Error('Audio context not initialized');\n    }\n\n    try {\n      const buffer = createAudioBuffer(this.audioContext, data);\n      if (!buffer) {\n        return;\n      }\n\n      const source = playAudioBuffer(\n        this.audioContext,\n        buffer,\n        this.startTimeRef,\n        this.analyzer || undefined\n      );\n\n      this.currentSource = source;\n      this.isPlaying = true;\n\n      source.onended = () => {\n        this.isPlaying = false;\n        this.currentSource = null;\n        this.handlers.onAudioEnd?.();\n      };\n\n      this.handlers.onAudioStart?.();\n    } catch (error) {\n      this.handleError(error as Error, 'queueAudio');\n      throw error;\n    }\n  }\n\n  public stop(): void {\n    if (this.currentSource) {\n      this.currentSource.stop();\n      this.currentSource = null;\n    }\n    this.isPlaying = false;\n    this.startTimeRef.current = 0;\n  }\n\n  public cleanup(): void {\n    this.stop();\n    \n    // Cleanup microphone manager\n    if (this.microphoneManager) {\n      this.microphoneManager.cleanup();\n      this.microphoneManager = null;\n    }\n    \n    if (this.audioContext) {\n      this.audioContext.close();\n      this.audioContext = null;\n    }\n    this.gainNode = null;\n    this.analyzer = null;\n  }\n\n  public getIsPlaying(): boolean {\n    return this.isPlaying;\n  }\n\n  public getIsRecording(): boolean {\n    return this.isRecording;\n  }\n\n  public addEventListener(_listener: (event: any) => void): () => void {\n    // TODO: Implement event listener functionality\n    return () => { };\n  }\n\n  public clearAudioQueue(): void {\n    this.stop();\n  }\n\n  public dispose(): void {\n    this.cleanup();\n  }\n\n  public getMicrophoneState() {\n    return this.microphoneManager?.getState() || null;\n  }\n\n  public hasMicrophone(): boolean {\n    return this.microphoneManager !== null;\n  }\n\n  public async checkMicrophonePermissions() {\n    // Initialize microphone manager on first use if not already initialized\n    if (!this.microphoneManager && this.options.microphoneConfig) {\n      try {\n        await this.initializeMicrophone();\n      } catch (error) {\n        this.handleError(error as Error, 'checkMicrophonePermissions - microphone initialization');\n        throw error;\n      }\n    }\n    \n    if (!this.microphoneManager) {\n      throw new Error('Microphone not configured. Provide microphoneConfig in AudioManagerOptions.');\n    }\n    return this.microphoneManager.checkPermissions();\n  }\n\n  public async startRecording(): Promise<void> {\n    // Initialize microphone manager on first use if not already initialized\n    if (!this.microphoneManager && this.options.microphoneConfig) {\n      try {\n        await this.initializeMicrophone();\n      } catch (error) {\n        this.handleError(error as Error, 'startRecording - microphone initialization');\n        throw error;\n      }\n    }\n    \n    if (!this.microphoneManager) {\n      throw new Error('Microphone not configured. Provide microphoneConfig in AudioManagerOptions.');\n    }\n    \n    try {\n      await this.microphoneManager.startRecording();\n      this.log('Recording started');\n    } catch (error) {\n      this.handleError(error as Error, 'startRecording');\n      throw error;\n    }\n  }\n\n  public stopRecording(): void {\n    if (!this.microphoneManager) {\n      this.log('Microphone not initialized');\n      return;\n    }\n    \n    try {\n      this.microphoneManager.stopRecording();\n      this.log('Recording stopped');\n    } catch (error) {\n      this.handleError(error as Error, 'stopRecording');\n    }\n  }\n}\n"]}