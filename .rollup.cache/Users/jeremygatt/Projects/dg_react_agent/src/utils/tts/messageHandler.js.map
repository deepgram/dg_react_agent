{"version":3,"file":"messageHandler.js","sourceRoot":"","sources":["messageHandler.ts"],"names":[],"mappings":"AAcA;IAGE,wBACU,OAAmC,EACnC,QAAmC;QADnC,wBAAA,EAAA,YAAmC;QACnC,yBAAA,EAAA,aAAmC;QADnC,YAAO,GAAP,OAAO,CAA4B;QACnC,aAAQ,GAAR,QAAQ,CAA2B;QAJrC,eAAU,GAAG,CAAC,CAAC;IAKpB,CAAC;IAIG,sCAAa,GAApB,UAAqB,IAAuC;QAC1D,IAAI,IAAI,YAAY,WAAW,EAAE;YAC/B,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;SAC7B;aAAM;YACL,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,CAAC;SAC/B;IACH,CAAC;IAEO,yCAAgB,GAAxB,UAAyB,IAAiB;;QACxC,IAAI,IAAI,CAAC,UAAU,KAAK,CAAC,EAAE;YACzB,OAAO;SACR;QAED,IAAM,UAAU,GAAe;YAC7B,IAAI,MAAA;YACJ,SAAS,EAAE,WAAW,CAAC,GAAG,EAAE;YAC5B,UAAU,EAAE,IAAI,CAAC,UAAU,EAAE;SAC9B,CAAC;QAEF,MAAA,MAAA,IAAI,CAAC,QAAQ,EAAC,WAAW,mDAAG,UAAU,CAAC,CAAC;IAC1C,CAAC;IAEO,2CAAkB,GAA1B,UAA2B,QAA6B;;QACtD,QAAQ,QAAQ,CAAC,IAAI,EAAE;YACrB,KAAK,UAAU;gBACb,MAAA,MAAA,IAAI,CAAC,QAAQ,EAAC,UAAU,mDAAG,QAAQ,CAAC,CAAC;gBACrC,MAAM;YAER,KAAK,SAAS;gBACZ,MAAA,MAAA,IAAI,CAAC,QAAQ,EAAC,SAAS,kDAAI,CAAC;gBAC5B,MAAM;YAER,KAAK,SAAS;gBACZ,MAAA,MAAA,IAAI,CAAC,QAAQ,EAAC,SAAS,kDAAI,CAAC;gBAC5B,MAAM;YAER,KAAK,OAAO;gBACV,IAAI,UAAU,IAAI,QAAQ,IAAI,SAAS,IAAI,QAAQ,EAAE;oBACnD,IAAI,CAAC,WAAW,CAAC;wBACf,IAAI,EAAE,OAAO;wBACb,QAAQ,EAAE,QAAQ,CAAC,QAAkB;wBACrC,OAAO,EAAE,QAAQ,CAAC,OAAiB;wBACnC,WAAW,EAAE,QAAQ,CAAC,WAAqB;qBAC5C,CAAC,CAAC;iBACJ;gBACD,MAAM;SACT;IACH,CAAC;IAEO,oCAAW,GAAnB,UAAoB,QAAmF;;QACrG,IAAM,KAAK,GAAa;YACtB,IAAI,EAAE,kBAAkB;YACxB,OAAO,EAAE,QAAQ,CAAC,OAAO;YACzB,IAAI,EAAE,KAAK;YACX,IAAI,EAAE,QAAQ,CAAC,QAAQ;YACvB,OAAO,EAAE;gBACP,gBAAgB,EAAE,QAAQ;gBAC1B,WAAW,EAAE,QAAQ,CAAC,WAAW;aAClC;SACF,CAAC;QAEF,IAAI,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE;YACtB,OAAO,CAAC,KAAK,CAAC,yBAAyB,EAAE,KAAK,CAAC,CAAC;SACjD;QAED,MAAA,MAAA,IAAI,CAAC,QAAQ,EAAC,OAAO,mDAAG,KAAK,CAAC,CAAC;IACjC,CAAC;IAEM,sCAAa,GAApB;QACE,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;IACtB,CAAC;IAEM,6CAAoB,GAA3B;QACE,OAAO,IAAI,CAAC,UAAU,CAAC;IACzB,CAAC;IACH,qBAAC;AAAD,CAAC,AArFD,IAqFC","sourcesContent":["import { DeepgramTTSResponse, TTSError, AudioChunk } from '../../types/tts';\n\ninterface MessageHandlerOptions {\n  debug?: boolean;\n}\n\ninterface MessageEventHandlers {\n  onAudioData?: (chunk: AudioChunk) => void;\n  onMetadata?: (metadata: any) => void;\n  onFlushed?: () => void;\n  onCleared?: () => void;\n  onError?: (error: TTSError) => void;\n}\n\nexport class MessageHandler {\n  private sequenceId = 0;\n\n  constructor(\n    private options: MessageHandlerOptions = {},\n    private handlers: MessageEventHandlers = {}\n  ) {}\n\n\n\n  public handleMessage(data: ArrayBuffer | DeepgramTTSResponse): void {\n    if (data instanceof ArrayBuffer) {\n      this.handleBinaryData(data);\n    } else {\n      this.handleJSONResponse(data);\n    }\n  }\n\n  private handleBinaryData(data: ArrayBuffer): void {\n    if (data.byteLength === 0) {\n      return;\n    }\n\n    const audioChunk: AudioChunk = {\n      data,\n      timestamp: performance.now(),\n      sequenceId: this.sequenceId++\n    };\n\n    this.handlers.onAudioData?.(audioChunk);\n  }\n\n  private handleJSONResponse(response: DeepgramTTSResponse): void {\n    switch (response.type) {\n      case 'Metadata':\n        this.handlers.onMetadata?.(response);\n        break;\n      \n      case 'Flushed':\n        this.handlers.onFlushed?.();\n        break;\n      \n      case 'Cleared':\n        this.handlers.onCleared?.();\n        break;\n      \n      case 'Error':\n        if ('err_code' in response && 'err_msg' in response) {\n          this.handleError({\n            type: 'Error',\n            err_code: response.err_code as string,\n            err_msg: response.err_msg as string,\n            description: response.description as string\n          });\n        }\n        break;\n    }\n  }\n\n  private handleError(response: { type: 'Error'; err_code: string; err_msg: string; description: string }): void {\n    const error: TTSError = {\n      name: 'DeepgramAPIError',\n      message: response.err_msg,\n      type: 'api',\n      code: response.err_code,\n      details: {\n        originalResponse: response,\n        description: response.description\n      }\n    };\n\n    if (this.options.debug) {\n      console.error('DeepgramTTS: API Error:', error);\n    }\n\n    this.handlers.onError?.(error);\n  }\n\n  public resetSequence(): void {\n    this.sequenceId = 0;\n  }\n\n  public getCurrentSequenceId(): number {\n    return this.sequenceId;\n  }\n} "]}