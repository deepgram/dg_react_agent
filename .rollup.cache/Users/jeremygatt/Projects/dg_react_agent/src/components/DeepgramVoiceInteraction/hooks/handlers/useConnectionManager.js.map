{"version":3,"file":"useConnectionManager.js","sourceRoot":"","sources":["useConnectionManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { useCallback } from 'react';\nimport { VoiceWebSocketManager } from '../../../../utils/websocket/VoiceWebSocketManager';\nimport { AudioManager } from '../../../../utils/audio/AudioManager';\nimport { AUDIO_CONFIG, MODEL_CONFIG } from '../../../../utils/shared/config';\nimport { AgentOptions } from '../../../../types/voice';\n\ninterface ConnectionManagerConfig {\n  apiKey: string;\n  transcriptionUrl: string;\n  agentUrl: string;\n  transcriptionOptions?: Record<string, any>;\n  agentOptions?: AgentOptions;\n  log: (message: string, level?: 'hook' | 'manager' | 'verbose') => void;\n}\n\nexport function useConnectionManager(\n  config: ConnectionManagerConfig,\n  managers: {\n    transcription: React.RefObject<VoiceWebSocketManager>;\n    agent: React.RefObject<VoiceWebSocketManager>;\n    audio: React.RefObject<AudioManager>;\n  }\n) {\n  const {\n    agentOptions,\n    log\n  } = config;\n\n  // Send agent settings\n  const sendAgentSettings = useCallback(() => {\n    if (!managers.agent.current || !agentOptions) return;\n\n    const settings = {\n      type: 'Settings',\n      audio: {\n        input: {\n          encoding: AUDIO_CONFIG.encoding,\n          sample_rate: AUDIO_CONFIG.sampleRate,\n        },\n        output: {\n          encoding: AUDIO_CONFIG.encoding,\n          sample_rate: AUDIO_CONFIG.sampleRate,\n        },\n      },\n      agent: {\n        language: agentOptions.language || 'en',\n        listen: {\n          provider: {\n            type: 'deepgram',\n            model: agentOptions.listenModel || MODEL_CONFIG.agent.listen,\n          },\n        },\n        think: {\n          provider: {\n            type: agentOptions.thinkProviderType || 'open_ai',\n            model: agentOptions.thinkModel || MODEL_CONFIG.agent.think,\n          },\n          prompt: agentOptions.instructions || 'You are a helpful voice assistant.',\n          ...(agentOptions.thinkEndpointUrl && agentOptions.thinkApiKey\n            ? {\n                endpoint: {\n                  url: agentOptions.thinkEndpointUrl,\n                  headers: {\n                    authorization: `bearer ${agentOptions.thinkApiKey}`,\n                  },\n                },\n              }\n            : {}),\n        },\n        speak: {\n          provider: {\n            type: 'deepgram',\n            model: agentOptions.voice || MODEL_CONFIG.agent.speak,\n          },\n        },\n        greeting: agentOptions.greeting,\n      },\n    };\n\n    managers.agent.current.sendJSON(settings);\n  }, [agentOptions]);\n\n  // Start the connection\n  const start = useCallback(async (): Promise<void> => {\n    try {\n      log('▶️ Starting voice interaction...');\n\n      // Connect transcription WebSocket if configured\n      if (managers.transcription.current) {\n        log('Connecting transcription WebSocket...');\n        await managers.transcription.current.connect();\n        log('Transcription WebSocket connected');\n      }\n\n      // Connect agent WebSocket if configured\n      if (managers.agent.current) {\n        log('Connecting agent WebSocket...');\n        await managers.agent.current.connect();\n        log('Agent WebSocket connected');\n      }\n\n      // Start recording if audio manager is available\n      if (managers.audio.current) {\n        log('Starting recording...');\n        await managers.audio.current.startRecording();\n        log('Recording started');\n      } else {\n        throw new Error('Audio manager not available');\n      }\n\n      log('✅ Voice interaction started successfully');\n    } catch (error) {\n      log(`❌ Error starting voice interaction: ${error instanceof Error ? error.message : 'Unknown error'}`);\n      throw error;\n    }\n  }, [log]);\n\n  // Stop the connection\n  const stop = useCallback(async (): Promise<void> => {\n    try {\n      log('⏹️ Stopping voice interaction...');\n\n      // Send CloseStream message to finalize any pending transcriptions\n      if (managers.transcription.current) {\n        log('Sending CloseStream message to finalize transcription');\n        managers.transcription.current.sendCloseStream();\n      }\n\n      // Stop recording\n      if (managers.audio.current) {\n        managers.audio.current.stopRecording();\n      }\n\n      // Add a small delay to allow final transcripts to be processed\n      await new Promise(resolve => setTimeout(resolve, 1000));\n\n      // Close WebSocket connections\n      if (managers.transcription.current) {\n        managers.transcription.current.disconnect();\n      }\n\n      if (managers.agent.current) {\n        managers.agent.current.disconnect();\n      }\n\n      log('✅ Voice interaction stopped');\n    } catch (error) {\n      log(`❌ Error stopping voice interaction: ${error instanceof Error ? error.message : 'Unknown error'}`);\n      throw error;\n    }\n  }, [log]);\n\n  return {\n    sendAgentSettings,\n    start,\n    stop\n  };\n} "]}