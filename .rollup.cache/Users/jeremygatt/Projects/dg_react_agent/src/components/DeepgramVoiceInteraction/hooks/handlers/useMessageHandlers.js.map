{"version":3,"file":"useMessageHandlers.js","sourceRoot":"","sources":["useMessageHandlers.ts"],"names":[],"mappings":"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","sourcesContent":["import { useCallback } from 'react';\nimport { VoiceWebSocketManager } from '../../../../utils/websocket/VoiceWebSocketManager';\nimport { AudioManager } from '../../../../utils/audio/AudioManager';\nimport { AgentState, TranscriptResponse, LLMResponse, UserMessageResponse } from '../../../../types/voice';\n\ninterface MessageHandlersConfig {\n  agentState: AgentState;\n  isWaitingForUserVoiceAfterSleep: { current: boolean };\n  userSpeakingRef: { current: boolean };\n  onTranscriptUpdate?: (transcript: TranscriptResponse) => void;\n  onAgentUtterance?: (response: LLMResponse) => void;\n  onUserMessage?: (message: UserMessageResponse) => void;\n  onUserStartedSpeaking?: () => void;\n  onUserStoppedSpeaking?: () => void;\n  setAgentState: (state: AgentState) => void;\n  log: (message: string, level?: 'hook' | 'manager' | 'verbose') => void;\n}\n\nexport function useMessageHandlers(\n  config: MessageHandlersConfig,\n  managers: {\n    transcription: React.RefObject<VoiceWebSocketManager>;\n    agent: React.RefObject<VoiceWebSocketManager>;\n    audio: React.RefObject<AudioManager>;\n  }\n) {\n  const {\n    agentState,\n    isWaitingForUserVoiceAfterSleep,\n    userSpeakingRef,\n    onTranscriptUpdate,\n    onAgentUtterance,\n    onUserMessage,\n    onUserStartedSpeaking,\n    onUserStoppedSpeaking,\n    setAgentState,\n    log\n  } = config;\n\n  // Handle transcription messages\n  const handleTranscriptionMessage = useCallback((data: any) => {\n    // Skip processing if transcription service isn't configured\n    if (!managers.transcription.current) {\n      log('Received unexpected transcription message but service is not configured:', data);\n      return;\n    }\n\n    // Check if agent is in sleep mode\n    const isSleepingOrEntering = agentState === 'sleeping' || agentState === 'entering_sleep';\n\n    if (data.type === 'VADEvent') {\n      const isSpeaking = data.is_speech;\n      if (isSleepingOrEntering) {\n        log('Ignoring VAD event (agent sleeping)', 'verbose');\n        return;\n      }\n\n      if (isSpeaking && !userSpeakingRef.current) {\n        userSpeakingRef.current = true;\n        onUserStartedSpeaking?.();\n      } else if (!isSpeaking && userSpeakingRef.current) {\n        userSpeakingRef.current = false;\n        onUserStoppedSpeaking?.();\n      }\n      return;\n    }\n\n    if (data.type === 'Results' || data.type === 'Transcript') {\n      if (isSleepingOrEntering) {\n        log('Ignoring transcript (agent sleeping)', 'verbose');\n        return;\n      }\n\n      const transcript = data as TranscriptResponse;\n      onTranscriptUpdate?.(transcript);\n      return;\n    }\n  }, [agentState, userSpeakingRef, onTranscriptUpdate, onUserStartedSpeaking, onUserStoppedSpeaking, log]);\n\n  // Handle agent messages\n  const handleAgentMessage = useCallback((data: any) => {\n    // Skip processing if agent service isn't configured\n    if (!managers.agent.current) {\n      log('Received unexpected agent message but service is not configured:', data);\n      return;\n    }\n\n    const isSleepingOrEntering = agentState === 'sleeping' || agentState === 'entering_sleep';\n\n    if (data.type === 'UserStartedSpeaking') {\n      log('UserStartedSpeaking message received');\n      if (isSleepingOrEntering) {\n        log('Ignoring UserStartedSpeaking event (agent sleeping)', 'verbose');\n        return;\n      }\n\n      // Normal speech handling when not sleeping\n      log('Clearing audio queue (barge-in)');\n      if (managers.audio.current) {\n        managers.audio.current.clearAudioQueue();\n      }\n      onUserStartedSpeaking?.();\n\n      if (isWaitingForUserVoiceAfterSleep.current) {\n        log('User started speaking after wake - resetting waiting flag');\n        isWaitingForUserVoiceAfterSleep.current = false;\n      }\n\n      setAgentState('listening');\n      return;\n    }\n\n    if (data.type === 'AgentThinking') {\n      setAgentState('thinking');\n      return;\n    }\n\n    if (data.type === 'AgentStartedSpeaking') {\n      setAgentState('speaking');\n      return;\n    }\n\n    if (data.type === 'AgentAudioDone') {\n      setAgentState('idle');\n      return;\n    }\n\n    // Handle conversation text\n    if (data.type === 'ConversationText') {\n      if (data.role === 'assistant') {\n        const response: LLMResponse = {\n          type: 'llm',\n          text: data.content || '',\n          metadata: data,\n        };\n\n        onAgentUtterance?.(response);\n        return;\n      } else if (data.role === 'user') {\n        const response = {\n          type: 'user' as const,\n          text: data.content || '',\n          metadata: data,\n        };\n\n        onUserMessage?.(response);\n        return;\n      }\n    }\n\n    // Handle warnings\n    if (data.type === 'Warning') {\n      log(`Agent warning: ${data.description}, Code: ${data.code}`, 'verbose');\n      return;\n    }\n  }, [agentState, isWaitingForUserVoiceAfterSleep, onAgentUtterance, onUserMessage, onUserStartedSpeaking, setAgentState, log]);\n\n  // Handle agent audio\n  const handleAgentAudio = useCallback((data: ArrayBuffer) => {\n    // Skip processing if agent service isn't configured\n    if (!managers.agent.current) {\n      log('Received unexpected agent audio but service is not configured');\n      return;\n    }\n\n    log(`Received agent audio buffer of ${data.byteLength} bytes`, 'verbose');\n\n    // Skip audio playback if we're waiting for user voice after sleep\n    if (isWaitingForUserVoiceAfterSleep.current) {\n      log('Skipping audio playback (waiting for user voice after sleep)', 'verbose');\n      return;\n    }\n\n    if (managers.audio.current) {\n      managers.audio.current.queueAudio(data)\n        .then(() => {\n          log('Successfully queued audio buffer for playback', 'verbose');\n        })\n        .catch(error => {\n          log(`Error queueing audio: ${error instanceof Error ? error.message : 'Unknown error'}`);\n        });\n    } else {\n      log('Cannot queue audio: audioManagerRef.current is null');\n    }\n  }, [isWaitingForUserVoiceAfterSleep, log]);\n\n  return {\n    handleTranscriptionMessage,\n    handleAgentMessage,\n    handleAgentAudio\n  };\n} "]}